<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/simple.css">
    <script src="js/uuid.js"></script>
    <script src="js/1000-utils.js"></script>
    <script type="text/javascript">
    //------------------------------------------------------------------
    // Closure
    //------------------------------------------------------------------
    // RPCのエンドポイント
    var rpcURL = (function () {
        var url = 'http://localhost:6001/api/v1';
        return function () {
            return url;
        };
    })();
    // 検査結果を格納しているcsvファイルへのURI
    var testResultURL = (function () {
        var url = 'http://localhost:6001/test_result.csv';
        return function () {
            return url;
        };
    })();
    // 上記csvをパースした検査項目の結果を入れる配列
    var tetItems = (function () {
        var items = [];
        return function () {
            return items;
        };
    })();

    // 患者
    var simplePatient = {
        id: '0516',                                        // 施設(病院)内で発番されている患者Id
        idType: 'facility',                                // 施設固有のIdであることを示す
        facilityId: 'JPN012345678901',                     // 医療連携等のために施設に振られているId
        kanjiName: '宮田 奈々',                             // 漢字の氏名
        kanaName: 'ミヤタ ナナ',                             // カナ
        romanName: 'Nana Miyata',                          // ローマ字
        sex: 'femail',                                     // MML0010(女:femail 男:male その他:other 不明:unknown)
        birthday: '1994-11-26',                            // 生年月日
        maritalStatus: 'single',                           // 婚姻状況 MML0011を使用 オプション
        nationality: 'JPN',                                // 国籍 オプション
        zipCode: '000-0000',                               // 郵便番号
        address: '横浜市中区日本大通り 1-23-4-567',            // 住所
        telephone: '054-078-7934',                         // 電話番号
        mobile: '090-2710-1564',                           // モバイル
        email: 'miyata_nana@example.com'                   // 電子メール オプション
    };

    // 医師等
    var simpleCreator = {
        id: '201605',                                      // 施設で付番されている医師のId
        idType: 'facility',                                // 施設固有のIdであることを示す
        kanjiName: '青山 慶二',                             // 医師名
        prefix: 'Professor',                               // 肩書き等 オプション
        degree: 'MD/PhD',                                  // 学位 オプション
        facilityId: 'JPN012345678901',                     // 医療連携等のために施設に振られているId
        facilityIdType: 'JMARI',                           // 上記施設IDを発番している体系 MML0027(ca|insurance|monbusho|JMARI|OID)から選ぶ
        facilityName: 'シルク内科',                          // 施設名
        facilityZipCode: '231-0023',                       // 施設郵便番号
        facilityAddress: '横浜市中区山下町1番地 8-9-01',      // 施設住所
        facilityPhone: '045-571-6572',                     // 施設電話番号
        departmentId: '01',                                // 医科用:MML0028 歯科用:MML0030 から選ぶ
        departmentIdType: 'medical',                       // 医科用の診療科コード:medical 歯科用の診療科コード:dental を指定 MML0029(medical|dental|facility)から選ぶ
        departmentName: '第一内科',                         // 診療科名
        license: 'doctor'                                  // 医療資格 MML0026から選ぶ
    };

    //------------------------------------------------------------------
    // 1000-builderへsimpleMMLをポストする（RPC）
    //------------------------------------------------------------------
    var post = function (simpleMML) {
        // ポストするデータの本体: JSON-RPC 2.0 の仕様で下記 JSON にする
        var jsonRpc2 = {
            jsonrpc: '2.0',                                         // 必ず '2.0' にする
            method: 'build',                                        // rpc の method名 'build'  <-- 千年ビルダーの仕様
            params: [simpleMML],                                    // params は配列で要素はsimpleMMLにする
            id: uuid.v4()                                           // id が必要 MMLの uuidとは別で JSON-RPC2.0 でも必要
        };
        // POST  with url=rpcURL() contentType="application/json" body=jsonRpc2 as text
        var http = new XMLHttpRequest();
        http.open('POST', rpcURL(), true);                               // async = true
        http.setRequestHeader('Content-type', 'application/json');       // http headder contentType
        http.onreadystatechange = function () {
            if (http.readyState === 4 && http.status/100 === 2) {
                // responseからJSONを生成する
                var data = JSON.parse(http.responseText);
                // {jsonRpc2:'jsonRpc2', result:{MML}, id=''} が返ってくるので result: を取り出す
                data = data.result;
                // 結果はMML(XML) なので 'pretty print する
                var xml_formatted = formatXml(data);
                // 表示するために escapeする
                xml_escaped = xml_formatted.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/ /g, '&nbsp;').replace(/\n/g,'<br />');
                // MML4.0 box へ表示する
                document.getElementById('mmlBox').innerHTML = xml_escaped;
            }
        }
        http.send(JSON.stringify(jsonRpc2));
    };

    // 処方せん
    var simplePrescription = function () {
        // 服薬開始日
        var startDate = nowAsDate();    // YYYY-MM-DD

        // リターンする simplePrescription
        var simple = {
            contentType: 'prescription',                    // prescriptionにする
            medication: []                                  // 処方の配列
        };

        var med = {
            issuedTo: 'external',                           // 院外処方: external 院内処方: internal
            medicine: 'マーズレン S 顆粒',                    // 処方薬
            medicineCode: '612320261',                      // 処方薬のコード
            medicineCodeSystem: 'YJ',                       // コード体系
            dose: 1,                                        // 1回の量
            doseUnit: 'g',                                  // 単位
            frequencyPerDay: 2,                             // 1日の内服回数
            startDate: startDate,                           // 服薬開始日 YYYY-MM-DD
            duration: 7,                                    // 7日分
            instruction: '内服2回 朝夜食後に',                 // 用法
            PRN: false,                                     // 頓用=false
            brandSubstitutionPermitted: true,               // ジェネリック可
            longTerm: false                                 // 臨時処方
        };
        simple.medication.push(med);                        // 配列へ格納

        med = {
            issuedTo: 'external',                           // 院外処方: external 院内処方: internal
            medicine: 'メトリジン錠 2 mg',                    // 処方薬
            medicineCode: '612160027',                      // 処方薬のコード
            medicineCodeSystem: 'YJ',                       // コード体系
            dose: 2,                                        // 1回の量
            doseUnit: '錠',                                 // 単位
            frequencyPerDay: 2,                             // 1日の内服回数
            startDate: startDate,                           // 服薬開始日
            duration: 14,                                   // 14日分
            instruction: '内服2回 朝夜食後に',                 // 用法
            PRN: false,                                     // 頓用=false
            brandSubstitutionPermitted: false,              // ジェネリック不可
            longTerm: true                                  // 長期処方
        };
        simple.medication.push(med);                        // 配列へ格納

        return simple;
    };

    // 病名
    // 1病名毎に1モジュール
    var simpleDiagnosis = function () {
        var now = new Date();
        var endDate = toDateString(now);                        // 終了日 = 今
        now.setDate(now.getDate() - 30);                        // 30日前が
        var startDate = toDateString(now);                      // 開始日

        return {
            contentType: 'registeredDiagnosis',             // registeredDiagnosisにする
            diagnosis: 'colon carcinoid',
            code: 'C189-.006',
            system: 'ICD10',
            category: 'mainDiagnosis',
            startDate: startDate,
            endDate: endDate,
            outcome: 'fullyRecovered'
        };
    };

    // ファイルコンテンツ(test_result.csv)から検査項目リストを生成する下請け
    var createTestItems = function (content) {
        var items = [];
        var lineArray = [];
        var simpleItem = {};
        // リターン区切りでline by line
        var lines = content.split("\n");
        // 最初の行はヘッダーなので除く
        lines.shift();
        lines.forEach(function (entry) {
            // この行をカンマ区切りで配列に格納する
            lineArray = entry.split(/\s*,\s*/);
            // この行のテスト項目
            simpleItem = {
                spcCode: lineArray[0],              // 検体コード
                spcName: lineArray[1],              // 検体名
                testCode: lineArray[2],             // コード
                testName: lineArray[3],             // テスト項目名
                testResult: lineArray[4]            // 結果値
            };

            if (lineArray[5] !== '') {
                simpleItem.unit = lineArray[5];              // 単位
            }
            if (lineArray[6] !== '' ) {
                simpleItem.low = lineArray[6];               // 下限値
            }
            if (lineArray[7] !== '' ) {
                simpleItem.up = lineArray[7];                // 上限値
            }
            if (lineArray[8] !== '' ) {
                simpleItem.out = lineArray[8];               // 判定フラグ
            }
            if (lineArray[9] !== '' && lineArray[10] !== '') {
                simpleItem.memoCode = lineArray[9];          // メモコード
                simpleItem.memo = lineArray[10];             // メモ
            }
            items.push(simpleItem);
        });
        return items;
    };

    var simpleLabTest = function (callback) {
        var test = {
            contentType: 'test',
            registId: uuid.v4(),                            // 検査Id 　運用で決める
            registTime: nowAsDateTime(),                    // 受付日時
            reportTime: nowAsDateTime(),                    // 報告日時
            reportStatusCode: 'final',                      // 報告状態コード  検査中:mid  最終報告:final
            reportStatusName: '最終報告',                    // 報告状態
            codeSystem: 'YBS_2016',                         // 検査コード体系名
            facilityName: simpleCreator.facilityName,       // 検査依頼施設
            facilityId: simpleCreator.facilityId,           // 検査依頼施設
            facilityIdType: 'JMARI',                        // 検査依頼施設
            labCenter: {
                id: '303030',                                // 検査実施会社内での Id
                idType: 'facility',                          // 施設で付番されているIdであることを示す
                kanjiName: '石山 由美子',                      // 検査実施施設の代表 代表とは?
                facilityId: '1.2.3.4.5.6.7890.1.2',          // OID
                facilityIdType: 'OID',                       // MML0027 OID 方式
                facilityName: 'ベイスターズ・ラボ',             // 検査実施会社の名称
                facilityZipCode: '231-0000',                 // 検査実施会社の郵便番号
                facilityAddress: '横浜市中区スタジアム付近 1-5', // 検査実施会社の住所
                facilityPhone: '045-000-0072',               // 検査実施会社の電話
                license: 'lab'                               // MML0026 他に?
            }
        };
        if (tetItems().length > 0) {
            test.testItem = tetItems();
            callback(test);
        } else {
            // 検査結果ファイルを読み込んで
            var http = new XMLHttpRequest();
            http.open("GET", testResultURL(), true);
            http.onreadystatechange = function () {
                if (http.readyState === 4 && http.status/100 === 2) {
                    // 検査結果オブジェクトを生成する
                    var items = createTestItems(http.responseText);
                    items.forEach (function (entry) {
                        tetItems().push(entry);
                    });
                    test.testItem = tetItems();
                    callback(test);
                }
            }
            http.send();
        }
    };

    // 検査情報をセットする
    var showLabTest = function () {

        simpleLabTest (function (simpleTest) {
            // staffs
            var confirmDate = simpleTest.reportTime;    // 検体検査の場合、確定日は報告日 YYYY-MM-DDTHH:mm:ss
            var uid = uuid.v4();                        // MML文書の UUID
            var simpleMML = {                           // POST = simpleMML
                patient: simplePatient,                 // 患者
                creator: simpleCreator,                 // 医師
                uuid: uid,                              // UUID
                confirmDate: confirmDate,               // 確定日時 YYYY-MM-DDTHH:mm:ss
                content: [simpleTest]                   // 中身をこのsimpleTestにする
            };

            // 表示
            var arr = [];
            arr.push('<pre>');
            arr.push('// 患者');
            arr.push('\n');
            arr.push('var simplePatient = ');
            arr.push(JSON.stringify(simplePatient, null, 4));
            arr.push(';');
            arr.push('\n');
            arr.push('// 医師');
            arr.push('\n');
            arr.push('var simpleCreator = ');
            arr.push(JSON.stringify(simpleCreator, null, 4));
            arr.push(';');
            arr.push('\n');
            arr.push('// 検査');
            arr.push('\n');
            arr.push('var simpleTest = ');
            arr.push(JSON.stringify(simpleTest, null, 4));
            arr.push(';');
            arr.push('</pre>');
            var text = arr.join('');
            document.getElementById('simpleBox').innerHTML = text;

            // POST する
            post(simpleMML);
        });
    };

    // 病名情報をセットする
    var showDiagnosis = function () {
        // staffs
        var diagnosis = simpleDiagnosis();          // 病名
        var confirmDate = nowAsDateTime();          // 確定日はこの時点　YYYY-MM-DDTHH:mm:ss
        var uid = uuid.v4();                        // MML文書の UUID
        var simpleMML = {                           // POST = simpleMML
            patient: simplePatient,                 // 患者
            creator: simpleCreator,                 // 医師
            uuid: uid,                              // UUID
            confirmDate: confirmDate,               // 確定日時 YYYY-MM-DDTHH:mm:ss
            content: [diagnosis]                    // 中身をこのdiagnosisにする
        };

        // 表示
        var arr = [];
        arr.push('<pre>');
        arr.push('// 患者');
        arr.push('\n');
        arr.push('var simplePatient = ');
        arr.push(JSON.stringify(simplePatient, null, 4));
        arr.push(';');
        arr.push('\n');
        arr.push('// 医師');
        arr.push('\n');
        arr.push('var simpleCreator = ');
        arr.push(JSON.stringify(simpleCreator, null, 4));
        arr.push(';');
        arr.push('\n');
        arr.push('// 病名');
        arr.push('\n');
        arr.push('var simpleDiagnosis = ');
        arr.push(JSON.stringify(diagnosis, null, 4));
        arr.push(';');
        arr.push('</pre>');
        var text = arr.join('');
        document.getElementById('simpleBox').innerHTML = text;

        // POST する
        post(simpleMML);
    };

    // 処方情報をセットする
    var showPrescription = function () {
        // staffs
        var prescription = simplePrescription();    // 処方せん
        var confirmDate = nowAsDateTime();          // このMMLの確定日はこの時点 YYYY-MM-DDTHH:mm:ss
        var uid = uuid.v4();                        // MML文書の UUID
        var simpleMML = {                           // POST = simpleMML
            patient: simplePatient,                 // 患者
            creator: simpleCreator,                 // 医師
            uuid: uid,                              // UUID
            confirmDate: confirmDate,               // 確定日時 YYYY-MM-DDTHH:mm:ss
            content: [prescription]                 // 中身をこのprescriptionにする
        };

        // 表示
        var arr = [];
        arr.push('<pre>');
        arr.push('// 患者');
        arr.push('\n');
        arr.push('var simplePatient = ');
        arr.push(JSON.stringify(simplePatient,null,4));
        arr.push(';');
        arr.push('\n');
        arr.push('// 医師');
        arr.push('\n');
        arr.push('var simpleCreator = ');
        arr.push(JSON.stringify(simpleCreator,null,4));
        arr.push(';');
        arr.push('\n');
        arr.push('// 処方せん');
        arr.push('\n');
        arr.push('var simplePrescription = ');
        arr.push(JSON.stringify(prescription, null, 4));
        arr.push(';');
        arr.push('</pre>');
        var text = arr.join('');
        document.getElementById('simpleBox').innerHTML = text;

        // POST する
        post(simpleMML);
    };

    // selectionが変更された
    var changeModule = function (selection) {
        window[selection.value]();
    };
    </script>
</head>
<body onload="showPrescription();">
    <div id="headerBar">
        <h1>1000 Years Builder</h1><a href="https://github.com/mbot-dev/1000_builder"><img src="image/GitHub-Mark-Light-32px.png"></a>
    </div>
    <div id="content">
        <div id="topSection">
            <p>千年ビルダーは、電子カルテなどの医療情報システムに簡単なAPIを提供し、千年カルテプロジェクトが必要とするMML4.0形式のデータを生成するサーバーアプリケーションです。</p>
            <h3>利用イメージ</h3>
            <ul>
                <li>患者さんがクリニックを受診しました。</li>
                <li>医師は処方せんを出しました。</li>
            </ul>
            <p>クライアントの医療情報システムはこの時の関係（患者、医師、処方）を簡単なJSONで表し、サーバーへポストします。左側がポストするデータ（選択可能）、右側がMML4.0にエンコードされたデータです。</p>
        </div>
        <div id="dataHeader">
            <div id="commandBar">
                <p>クライアントがポストするデータ:
                    <select onchange="changeModule(this);" style="vertical-align:center;">
                        <option value='showPrescription'>処 方</option>
                        <option value='showDiagnosis'>病 名</option>
                        <option value='showLabTest'>検 査</option>
                    </select>
                </p>
            </div>
            <div id="mmlBar"><p>サーバーが生成した MML4.0</p></div>
            <div style="clear:both;"></div>
        </div>
        <!-- -->
        <div id="simpleBox"></div>
        <div id="mmlBox"></div>
        <!-- -->
        <div id="bottomSection">
            <p>　</p>
            <p style="font-size:small;text-align:center;">サンプルデータの個人名には<a href="http://kazina.com/dummy/">なんちゃって個人情報</a>を使用しています。</p>
            <h3>データ利用</h3>
            <ul>
                <li>サーバーが生成したMMLを千年カルテプロジェクトに送信します。</li>
                <li>この時デフォルトで次のアクセス権が設定されます。
                    <ul>
                        <li>診察した病院: 参照、修正、削除する全権限</li>
                        <li>患者: 参照のみ</li>
                        <li>患者が受診したことのある病院: 参照可</li>
                    </ul>
                </li>
            </ul>
            <h3>このサーバーの目的</h3>
            <p>MMLは医療情報を1000年に渡って活用できるようにするため、情報を多くの名前空間と深い階層によって定義しています。これをサポートするのは、新規のアプリケーションであっても既存の製品であっても、かなりのコストが必要です。千年ビルダーはそこへシンプルなAPIを提供します。クライアントがポストするのは簡単なJSONで、属性は殆どが自明なものばかりです。
                したがって、
            </p>
            <uL>
                <li>医療システムベンダーは、自社の製品に（既存であっても）千年カルテの機能をより簡単に組み込むことができます。</li>
                <li>千年基盤はこのサーバーだけを検証すればよく、信頼性が向上し、コストが下がります。</li>
                <li>モバイルアプリからの送信も容易となり、院内の全ての場所、薬局、介護、リハビリ等、医療連携の幅が広がります。</li>
            </ul>
            <h3>クライアントの開発資料</h3>
            <uL>
                <li><a href="https://github.com/mbot-dev/1000_builder/wiki/simple">Wiki</a> に仕様及び設定ガイドがあります。</li>
                <li><a href="https://github.com/mbot-dev/1000_builder">GitHub</a> にクライント及びサーバーのソースコードが置いてあります。</li>
                <li>このサーバーは IBM Bluemix 基盤で動いています。これをテストで使用することができます。</li>
                <li>クライアントとサーバーの通信方式はJSONによるリモートプロシジャーコールです。システムの実装言語に依存しません。</li>
            </ul>
            <h3>関連情報</h3>
            <ul>
                <li><a href="https://www.facebook.com/gEHR-398609153661839/">千年カルテプロジェクト</a></li>
                <li><a href="http://www.medxml.net/MML40j/mml4.html">MML4.0</a></li>
                <li><a href="https://gist.github.com/dolphin-dev/f177a57c91d527e01059">カルテに記載される情報</a></li>
                <li><a href="https://gist.github.com/dolphin-dev/c0d59774ecfbe47c0b3b">確定日について</a></li>
            </ul>
        </div>
    </div>
    <div id="footerBar">
        <p>©2016 Kazushi Minagawa.</p>
    </div>
</body>
</html>
